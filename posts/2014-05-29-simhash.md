title: SimHash or the way to compare quickly two datasets
date: 2014-05-29
tags: [ comparison, fingerprint, jaccard, php, simhash ]
comments: true
intro: >
    SimHash is an **algorithm created by Moses Charikar**, from Google. It let us to compare easily
    two texts, and by the way two datasets of any type, quickly and effectively.
---


SimHash is an algorithm created by Moses Charikar, from Google. It is an effective tool to
compare easily and very fast two datasets.

What does this really mean? Let's talk a bit about it.


### The similarity problem

Computers are very pragmatic. They can find very fast if two elements are differents or not.
It's a binary world: equal or different.

Imagine now that we would like to have an idea of the similarity between these two elements.
That would be a much bigger problem: a computer is not designed to do such comparison by nature.
It's difficult, so it takes resources.

For a better understanding I will take the example of these two texts from Shakespeare:

``` no-highlight
He hath abandoned his physicians; under whose
practises he hath persecuted time with hope and
finds no other advantage in the process but only the
losing of hope.
```

``` no-highlight
He hath abandoned his physicians, madam; under whose
practises he hath persecuted time with hope and
finds no other advantage in the process but only the
losing of hope.
```

So, here we have `, madam` added in the second text.

How the computer will find if the texts are equals (strictly)? It will browse the first
text and see if the letter in its current position is the same in the other text.

But the point here is that if the computer find a difference, **it stops**. It does not
use anymore resources. It knows that the strings are strictly differents.

That's where similarity is a challenge. If we check for strict equality, we only need
to stop on the first difference. If we want a similarity estimation, we have to check
the entiere text. In math it would be:

$similarity(A, B) = \frac{A \cap B}{A \cup B}$

For big datasets, the part $A \cap B$ is complex. That's where SimHash is useful.

With SimHash, we will create a fingerprint that will replace the datasets A and B:

$simhash(A) \cap simhash(B)$

Thus we will compare much smaller elements, the comparison time will be dramatically reduced.


### SimHash or the way to create fingerprints

To compare fingerprints, we need an algorithm that generate them using a bigger dataset.
The first idea would be to use hash (md5, sha1). However, these hash change a lot if the input
change a bit. We need another algorithm that change a bit if the text does not change a lot.
Simhash does that.

The official SimHash algorithm is:

- Define a fingerprint size (for instance 32 bits)
- Create an array V[] filled with this size of zeros
- For each element in the dataset, we create a unique hash with md5, sha1 of any other hash algorithm that
  give same-sized results
- For each hash, for each bit i in this hash:
    - If the bit is 0, we add 1 to V[i]
    - If the bit is 1, we take 1 to V[i]
- For each i
    - If V[i] > 0, i = 1
    - If V[i] < 0, i = 0
    
It gives us a fingerprint characterizing our text, an approximation of the text data.

A fingerprint is a binary number, for instance: `10101011100010001010000101111100`. Now, to find

$simhash(A) \cap simhash(B)$

we only have to use a XOR operation, for instance:

``` no-highlight
    10101011100010001010000101111100
XOR 10101011100010011110000101111110
  = 00000000000000010100000000000010
```

Here, the 1 in the XOR result are the differences between the two fingerprints.
To get an idea of the difference between the original texts, we juste have to count
the number of 1 and divide it by the total size.

We have 3 ones for 32 characters, so we have 3 differences per 32 elements : the
estimation of the difference is 3 / 32 = 0,09375.

And for the similarity: 1 - 3 / 32 = 0,90625, a bit more than 90%. We have a similarity index!


### Real world usage

SimHash is currently used by Google to compare page with its database, to avoid dupplicate
contents. But we can use it too!

I created a small PHP library to use programatically SimHash: SimHashPHP.

But the main usage of SimHash is to compare things in a database. For instance, let's
imagine we want to find the most similar articles of the one we are currently reading.
It appears complicated at the first sight using only SQL. However with SimHash it's not
that difficult: we just have to store a fingerprint for each aticle, and use the XOR
operation in SQL to count the 1 in the binary result.

For instance:

``` sql
SELECT id, title, (LENGTH(CONV(fp ^ ?, 10, 2)) - LENGTH(REPLACE(CONV(fp ^ ?, 10, 2), '1', ''))) / LENGTH('1') AS comparison
FROM articles
ORDER BY comparison ASC
```

PHP :

``` php
<?php

//template language,english, french or zh
$blog_config['language'] = 'english';

//blog title
$blog_config['title'] = 'Titouan Galopin';
//blog sub title
$blog_config['intro'] = 'Web and Mobile Developer';
//blog author
$blog_config['author'] = 'Titouan Galopin';
//"About Me" box
$blog_config['aboutme'] = 'This is about JustWriting';
//blog avatar
$blog_config['avatar'] = 'http://www.titouangalopin.com/blog/system/cms/themes/tga/img/tgalopin.jpg';

//blog template name.The template root path is /templates.You can set rock or deepure.
$blog_config['template'] = 'deepure';

//If you would like that everyone comment your post,you must set this variable to True.
$blog_config['comment'] = true;
//duoshuo short nameï¼Œduoshuo is the social comment system,url is  http://duoshuo.com/.
$blog_config['duoshuo_short_name'] = '';
//disqus short name
$blog_config['disqus_short_name'] = '';

//URL to your blog root.This is your base URL,without  a trailing slash:http://justwriting.sinaapp.com
$blog_config['base_url'] = 'http://dropplet.dev';

//your github url
$blog_config['github'] = 'https://github.com/tgalopin';

//other social network : twitter, facebook, rss and email. For example :
$blog_config['twitter'] = '';
//there's more supported networks, but you must add them manually to \templates\rock\base.html - names are in \templates\rock\images\social\*

//posts count of posts list
$blog_config['posts_per_page'] = 10;

//on or off API.  API doc : https://github.com/hjue/JustWriting/wiki/API .
$blog_config['api'] = False;
//api key
$blog_config['api_key'] = '1234561';

//dropbox settings,for more infomation pls see the README : https://github.com/hjue/JustWriting
$blog_config['dropbox']['key']= '';
$blog_config['dropbox']['secret']= '';
$blog_config['dropbox']['access_token']= '';

/*
 * Supports code highlightin.If you don't write code in post,set this to empty.
 * Support 49 code styles, pls see this page: https://highlightjs.org/static/test.html
 */
$blog_config['highlight']='default';

//remove comment to support Latex math equations
$blog_config['mathjax']='<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default">
MathJax.Hub.Config({
    tex2jax: {
         inlineMath: [ ["$","$"]]
         },
     extensions: ["jsMath2jax.js", "tex2jax.js"],
     messageStyle: "none"
 });</script>';
```
